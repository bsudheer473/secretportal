# Deployment Artifacts

This document lists all deployment-related files and scripts created for the Secrets Management Portal.

## Deployment Scripts

### Infrastructure

| File | Purpose | Usage |
|------|---------|-------|
| `deploy.sh` | Main deployment script | `./deploy.sh [dev\|staging\|prod]` |
| `setup-cognito-users.sh` | Create test users and groups | `./setup-cognito-users.sh [env]` |
| `test-authentication.sh` | Test user authentication | `./test-authentication.sh [env] [user] [pass]` |

### Backend

| File | Purpose | Usage |
|------|---------|-------|
| `build-lambda.js` | Build Lambda functions with esbuild | `npm run build:lambda` |
| `verify-deployment.sh` | Verify Lambda deployment | `./verify-deployment.sh [env]` |

### Frontend

| File | Purpose | Usage |
|------|---------|-------|
| `build-and-deploy.sh` | Build and deploy frontend | `npm run deploy:[env]` |

## Configuration Files

### Infrastructure

| File | Purpose |
|------|---------|
| `bin/app.ts` | CDK app entry point with environment config |
| `cdk.json` | CDK configuration |
| `package.json` | NPM scripts for deployment |

### Backend

| File | Purpose |
|------|---------|
| `package.json` | Build scripts and dependencies |
| `tsconfig.json` | TypeScript configuration |

### Frontend

| File | Purpose |
|------|---------|
| `.env.example` | Environment variable template |
| `.env.production` | Auto-generated production config |
| `package.json` | Build and deployment scripts |
| `vite.config.ts` | Vite build configuration |

## Infrastructure Stacks

### Main Stack

| File | Purpose |
|------|---------|
| `lib/secrets-portal-stack.ts` | Main orchestration stack |

### Sub-Stacks

| File | Purpose |
|------|---------|
| `lib/stacks/storage-stack.ts` | DynamoDB tables |
| `lib/stacks/authentication-stack.ts` | Cognito User Pool |
| `lib/stacks/compute-stack.ts` | Lambda functions |
| `lib/stacks/networking-stack.ts` | API Gateway |
| `lib/stacks/frontend-stack.ts` | S3 and CloudFront |

## Documentation

| File | Purpose |
|------|---------|
| `DEPLOYMENT.md` | Infrastructure deployment guide |
| `TESTING.md` | Testing procedures |
| `DEPLOYMENT_ARTIFACTS.md` | This file |
| `../backend/README.md` | Backend documentation |
| `../frontend/DEPLOYMENT.md` | Frontend deployment guide |
| `../../DEPLOYMENT_GUIDE.md` | Complete deployment guide |
| `../../QUICK_REFERENCE.md` | Quick command reference |

## Environment Variables

### Infrastructure Deployment

```bash
CDK_DEFAULT_ACCOUNT=123456789012
CDK_DEFAULT_REGION=us-east-1
NOTIFICATION_EMAIL=admin@example.com
```

### Lambda Functions (Auto-configured by CDK)

```bash
USER_POOL_ID=us-east-1_XXXXXXXXX
CLIENT_ID=XXXXXXXXXXXXXXXXXXXXXXXXXX
SECRETS_METADATA_TABLE=secrets-metadata
AUDIT_LOG_TABLE=secrets-audit-log
METADATA_TABLE_NAME=secrets-metadata
SNS_TOPIC_ARN=arn:aws:sns:...
AWS_REGION=us-east-1
AWS_NODEJS_CONNECTION_REUSE_ENABLED=1
```

### Frontend (Auto-generated by build-and-deploy.sh)

```bash
VITE_API_ENDPOINT=https://...execute-api.us-east-1.amazonaws.com/prod/
VITE_USER_POOL_ID=us-east-1_XXXXXXXXX
VITE_USER_POOL_CLIENT_ID=XXXXXXXXXXXXXXXXXXXXXXXXXX
VITE_AWS_REGION=us-east-1
```

## CloudFormation Outputs

After deployment, the following outputs are available:

| Output Key | Description |
|------------|-------------|
| `ApiEndpoint` | API Gateway endpoint URL |
| `UserPoolId` | Cognito User Pool ID |
| `UserPoolClientId` | Cognito User Pool Client ID |
| `RotationTopicArn` | SNS topic ARN for notifications |
| `FrontendUrl` | CloudFront distribution URL |
| `FrontendBucketName` | S3 bucket name for frontend |
| `DistributionId` | CloudFront distribution ID |
| `FrontendConfig` | JSON with all frontend config |

## AWS Resources Created

### Compute

- 3 Lambda functions (auth, secrets, rotation-checker)
- 1 EventBridge rule (daily rotation check)

### Storage

- 2 DynamoDB tables (metadata, audit-log)
- 1 S3 bucket (frontend hosting)
- AWS Secrets Manager (secrets stored here)

### Networking

- 1 API Gateway REST API
- 1 CloudFront distribution
- 1 Origin Access Identity

### Security

- 1 Cognito User Pool
- 1 Cognito User Pool Client
- 13 Cognito User Groups
- Multiple IAM roles and policies

### Monitoring

- CloudWatch Log Groups (one per Lambda)
- 1 SNS topic (rotation notifications)

## Deployment Flow

```
1. Build shared-types
   ↓
2. Build backend
   ↓
3. Build infrastructure
   ↓
4. CDK synth (generate CloudFormation)
   ↓
5. CDK deploy (create/update resources)
   ↓
6. Setup Cognito users (optional)
   ↓
7. Build frontend
   ↓
8. Deploy to S3
   ↓
9. Invalidate CloudFront cache
   ↓
10. Test authentication
```

## Rollback Procedures

### Infrastructure Rollback

```bash
# Cancel in-progress update
aws cloudformation cancel-update-stack \
  --stack-name SecretsPortalStack-Dev

# Or delete and redeploy
npm run destroy:dev
./deploy.sh dev
```

### Frontend Rollback

```bash
# S3 versioning is enabled
aws s3api list-object-versions \
  --bucket secrets-portal-frontend-ACCOUNT-REGION

# Restore previous version
aws s3api copy-object \
  --copy-source bucket/key?versionId=VERSION_ID \
  --bucket bucket \
  --key key

# Invalidate CloudFront
aws cloudfront create-invalidation \
  --distribution-id DISTRIBUTION_ID \
  --paths "/*"
```

## CI/CD Integration

### Pipeline Steps

```yaml
# Example GitHub Actions workflow
steps:
  - name: Install dependencies
    run: npm install

  - name: Build packages
    run: npm run build

  - name: Deploy infrastructure
    run: |
      cd packages/infrastructure
      npm run deploy:${ENVIRONMENT}

  - name: Deploy frontend
    run: |
      cd packages/frontend
      npm run deploy:${ENVIRONMENT}

  - name: Test deployment
    run: |
      cd packages/infrastructure
      ./test-authentication.sh ${ENVIRONMENT} admin Admin123!
```

## Maintenance Tasks

### Regular Tasks

- Monitor CloudWatch logs and metrics
- Review audit logs in DynamoDB
- Rotate test user passwords
- Update Lambda function code
- Review and update IAM policies

### Periodic Tasks

- Update dependencies (npm audit)
- Review CloudWatch alarms
- Clean up old CloudWatch logs
- Review S3 bucket versions
- Update CDK version

## Cost Estimation

Approximate monthly costs (dev environment):

- Lambda: $5-10 (based on invocations)
- API Gateway: $3-5 (based on requests)
- DynamoDB: $5-10 (on-demand pricing)
- S3: $1-2 (storage and requests)
- CloudFront: $1-5 (data transfer)
- Cognito: Free tier (< 50,000 MAU)
- Secrets Manager: $0.40 per secret per month

**Total: ~$15-35/month for dev environment**

Production costs will be higher based on usage.

## Support Contacts

- AWS Support: [AWS Support Center](https://console.aws.amazon.com/support/)
- CDK Issues: [AWS CDK GitHub](https://github.com/aws/aws-cdk/issues)
- Internal Support: [Your team contact]

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2024-01-22 | Initial deployment configuration |

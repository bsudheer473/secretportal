# Quick Reference - Deployment Commands

## Initial Setup

```bash
# Install dependencies
npm install

# Build all packages
npm run build

# Bootstrap CDK (first time only)
cd packages/infrastructure
cdk bootstrap
```

## Deploy Infrastructure

```bash
cd packages/infrastructure

# Development
./deploy.sh dev

# Staging
./deploy.sh staging

# Production
./deploy.sh prod
```

## Deploy Frontend

```bash
cd packages/frontend

# Development
npm run deploy:dev

# Staging
npm run deploy:staging

# Production
npm run deploy:prod
```

## Set Up Users

```bash
cd packages/infrastructure

# Create test users
./setup-cognito-users.sh dev
./setup-cognito-users.sh staging
./setup-cognito-users.sh prod
```

## Test Authentication

```bash
cd packages/infrastructure

# Test with admin user
./test-authentication.sh dev admin Admin123!

# Test with app-specific user
./test-authentication.sh dev app1-dev App1Dev123!
```

## Verify Deployment

```bash
cd packages/backend

# Verify Lambda functions
./verify-deployment.sh dev
./verify-deployment.sh staging
./verify-deployment.sh prod
```

## Get Stack Outputs

```bash
# API Endpoint
aws cloudformation describe-stacks \
  --stack-name SecretsPortalStack-Dev \
  --query "Stacks[0].Outputs[?OutputKey=='ApiEndpoint'].OutputValue" \
  --output text

# Frontend URL
aws cloudformation describe-stacks \
  --stack-name SecretsPortalStack-Dev \
  --query "Stacks[0].Outputs[?OutputKey=='FrontendUrl'].OutputValue" \
  --output text

# User Pool ID
aws cloudformation describe-stacks \
  --stack-name SecretsPortalStack-Dev \
  --query "Stacks[0].Outputs[?OutputKey=='UserPoolId'].OutputValue" \
  --output text

# All outputs
aws cloudformation describe-stacks \
  --stack-name SecretsPortalStack-Dev \
  --query "Stacks[0].Outputs"
```

## View Logs

```bash
# Lambda logs
aws logs tail /aws/lambda/SecretsPortalStack-Dev-ComputeSecretsFunction --follow

# API Gateway logs
aws logs tail /aws/apigateway/SecretsPortalApi --follow
```

## Update Deployment

```bash
# Update infrastructure
cd packages/infrastructure
./deploy.sh dev

# Update frontend
cd packages/frontend
npm run deploy:dev
```

## Destroy Resources

```bash
cd packages/infrastructure

# Development
npm run destroy:dev

# Staging
npm run destroy:staging

# Production
npm run destroy:prod
```

## Test Users

| Username | Password | Groups | Access |
|----------|----------|--------|--------|
| admin | Admin123! | secrets-admin | Full access |
| app1-dev | App1Dev123! | app1-developer | App1 NP/PP read/write |
| app1-viewer | App1View123! | app1-prod-viewer | App1 Prod read-only |
| app2-dev | App2Dev123! | app2-developer | App2 NP/PP read/write |
| app2-viewer | App2View123! | app2-prod-viewer | App2 Prod read-only |
| app3-dev | App3Dev123! | app3-developer | App3 NP/PP read/write |
| app3-viewer | App3View123! | app3-prod-viewer | App3 Prod read-only |
| multi-app | MultiApp123! | Multiple | Multiple apps |

## Environment Variables

### Infrastructure Deployment

```bash
export CDK_DEFAULT_ACCOUNT=123456789012
export CDK_DEFAULT_REGION=us-east-1
export NOTIFICATION_EMAIL=admin@example.com
```

### Frontend Build

Automatically generated by `build-and-deploy.sh`:
- `VITE_API_ENDPOINT`
- `VITE_USER_POOL_ID`
- `VITE_USER_POOL_CLIENT_ID`
- `VITE_AWS_REGION`

## Common Tasks

### Create a New User

```bash
USER_POOL_ID=$(aws cloudformation describe-stacks \
  --stack-name SecretsPortalStack-Dev \
  --query "Stacks[0].Outputs[?OutputKey=='UserPoolId'].OutputValue" \
  --output text)

aws cognito-idp admin-create-user \
  --user-pool-id "$USER_POOL_ID" \
  --username john.doe \
  --user-attributes Name=email,Value=john.doe@company.com \
  --desired-delivery-mediums EMAIL

aws cognito-idp admin-add-user-to-group \
  --user-pool-id "$USER_POOL_ID" \
  --username john.doe \
  --group-name app1-developer
```

### Subscribe to Rotation Notifications

```bash
TOPIC_ARN=$(aws cloudformation describe-stacks \
  --stack-name SecretsPortalStack-Dev \
  --query "Stacks[0].Outputs[?OutputKey=='RotationTopicArn'].OutputValue" \
  --output text)

aws sns subscribe \
  --topic-arn "$TOPIC_ARN" \
  --protocol email \
  --notification-endpoint your-email@example.com
```

### Manually Trigger Rotation Check

```bash
ROTATION_FUNCTION=$(aws cloudformation describe-stack-resources \
  --stack-name SecretsPortalStack-Dev \
  --query "StackResources[?ResourceType=='AWS::Lambda::Function' && contains(LogicalResourceId, 'Rotation')].PhysicalResourceId" \
  --output text)

aws lambda invoke \
  --function-name "$ROTATION_FUNCTION" \
  --payload '{}' \
  response.json
```

### Invalidate CloudFront Cache

```bash
DISTRIBUTION_ID=$(aws cloudformation describe-stacks \
  --stack-name SecretsPortalStack-Dev \
  --query "Stacks[0].Outputs[?OutputKey=='DistributionId'].OutputValue" \
  --output text)

aws cloudfront create-invalidation \
  --distribution-id "$DISTRIBUTION_ID" \
  --paths "/*"
```

## Troubleshooting

### Check Stack Status

```bash
aws cloudformation describe-stacks \
  --stack-name SecretsPortalStack-Dev \
  --query "Stacks[0].StackStatus"
```

### View Stack Events

```bash
aws cloudformation describe-stack-events \
  --stack-name SecretsPortalStack-Dev \
  --max-items 20
```

### Check Lambda Function

```bash
aws lambda get-function \
  --function-name SecretsPortalStack-Dev-ComputeSecretsFunction
```

### Test API Endpoint

```bash
# Get token first
AUTH_RESULT=$(aws cognito-idp admin-initiate-auth \
  --user-pool-id "$USER_POOL_ID" \
  --client-id "$CLIENT_ID" \
  --auth-flow ADMIN_NO_SRP_AUTH \
  --auth-parameters USERNAME=admin,PASSWORD=Admin123!)

ID_TOKEN=$(echo "$AUTH_RESULT" | jq -r '.AuthenticationResult.IdToken')

# Test API
curl -H "Authorization: Bearer $ID_TOKEN" \
  "${API_ENDPOINT}secrets"
```

## Documentation

- [Complete Deployment Guide](DEPLOYMENT_GUIDE.md)
- [Infrastructure Deployment](packages/infrastructure/DEPLOYMENT.md)
- [Frontend Deployment](packages/frontend/DEPLOYMENT.md)
- [Testing Guide](packages/infrastructure/TESTING.md)
